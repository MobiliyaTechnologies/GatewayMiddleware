<html>
   
   <head>
      <title>Asset Monitoring Configuration</title>
      <script src = "https://ajax.googleapis.com/ajax/libs/angularjs/1.3.14/angular.min.js"></script>
	  <script src = "hello.all.js"></script>
   </head>
   
   <body>
      <h2>Asset Monitoring Configuration</h2>
      
      <div ng-app = "gatewayApp" ng-controller = "mainController">
         Enter Rest Server Url: <input type = "text" ng-model = "config.restServer"><br><br>
         Enter B2c Application Id: <input type = "text" ng-model = "config.b2cApplicationId"><br>
		 Enter B2c Tenant Name: <input type = "text" ng-model = "config.tenantName"><br>
		 Enter B2c Sign In Policy: <input type = "text" ng-model = "config.signInPolicyName"><br>
		 <button ng-click = "submit('click')">Submit</button>
		 
		 
         <br>
         
         
      </div>
      
      <script>
         var mainApp = angular.module("gatewayApp", []);
         mainApp.factory('aadService', function ($http) {
        var responseType = 'token id_token';
        var redirectURI = './redirect.html';
        var loginDisplayType = {
            PopUp: 'popup',
            None: 'none',
            Page: 'page'

        };

        var helloNetwork = {
            adB2CSignIn: 'adB2CSignIn',
            adB2CSignInSignUp: 'adB2CSignInSignUp',
            adB2CEditProfile: 'adB2CEditProfile'
        };
        return {
            signIn: function (config,callback) {
				console.log("config",config)
                hello.init({
                    adB2CSignIn: config.b2cApplicationId,
                    adB2CSignInSignUp: config.b2cApplicationId,
                    adB2CEditProfile: config.b2cApplicationId
                }, {
                        redirect_uri: '/redirect.html',
                        scope: 'openid ' + config.b2cApplicationId,
                        response_type: 'token id_token'
                    });
                var b2cSession = hello(helloNetwork.adB2CSignIn).getAuthResponse();
				console.log("b2cSession",b2cSession)
                callback(b2cSession);
            },
            signUp: function (config,callback) {
                var applicationId = config.b2cApplicationId;
                hello.init({
                    adB2CSignIn: applicationId,
                    adB2CSignInSignUp: applicationId,
                    adB2CEditProfile: applicationId
                }, {
                        redirect_uri: '../redirect.html',
                        scope: 'openid ' + applicationId,
                        response_type: 'token id_token'
                    });
                this.policyLogin(helloNetwork.adB2CSignInSignUp, loginDisplayType.Page);
            },
            logout: function () {
                var applicationId = config.b2cApplicationId;
                hello.init({
                    adB2CSignIn: applicationId,
                    adB2CSignInSignUp: applicationId,
                    adB2CEditProfile: applicationId
                }, {
                        redirect_uri: '/redirect.html',
                        scope: 'openid ' + applicationId,
                        response_type: 'token id_token'
                    });
                this.policyLogout(helloNetwork.adB2CSignIn, config.signInPolicyName);
            },
            policyLogin: function (network, displayType) {
				console.log("network",network);
				console.log("displayType",displayType);
                if (!displayType) {
                    displayType = 'page';
                }
                var b2cSession = hello(network).getAuthResponse();
				
                //in case of silent renew, check if the session is still active otherwise ask the user to login again
                if (!this.online(b2cSession) && displayType === loginDisplayType.None) {
                    bootbox.alert('Session expired... please login again', function () {
                        this.policyLogin(network, loginDisplayType.Page);
                    });
                    return;
                }
				
                hello(network).login({ display: displayType }, this.log).then(function (auth) {
					
                }, function (e) {
					console.log("b2cSession1",b2cSession);
                    if ('Iframe was blocked' in e.error.message) {
                        this.policyLogin(network, loginDisplayType.Page);
                        return;
                    }
                    bootbox.alert('Signin error: ' + e.error.message);
                });
            },
            policyLogout: function (network, policy) {
                hello.logout(network, { force: true }).then(function (auth) {
                    console.log("auth :", auth);
                }, function (e) {
                    console.log("Erorr :", e);
                });
            },
            online: function (session) {
                var currentTime = (new Date()).getTime() / 1000;
                return session && session.access_token && session.expires > currentTime;
            },
            log: function (s) {

                if (typeof s.error !== 'undefined' && s.error !== null) {
                    if (s.error.code === 'blocked') {   //silentrenew(display: none) in case of expired token returns X-frame Options as DENY error
                        bootbox.alert("<p class='bg-danger'>there was an error in silent renewing the token. Please login again</p>");
                        return;
                    }
                }
                else
                    document.body.querySelector('.response')
                        .appendChild(document.createTextNode(JSON.stringify(s, true, 2)));
            }


        };
    });
         mainApp.controller('mainController', function($scope,aadService,$http){ 
		 $scope.config={restServer:'',
						'b2cApplicationId':'',
            'tenantName': "",
            'signInPolicyName': ""
            //'signInSignUpPolicyName': ""
			
			} 
		var loginDisplayType = {
            PopUp: 'popup',
            None: 'none',
            Page: 'page'
        };
        var helloNetwork = {
            adB2CSignIn: 'adB2CSignIn',
            adB2CSignInSignUp: 'adB2CSignInSignUp',
            adB2CEditProfile: 'adB2CEditProfile'
        };
		 function online(session) {

            var currentTime = (new Date()).getTime() / 1000;
            return session && session.access_token && session.expires > currentTime;
        };
		 $scope.submit=function(state){
				localStorage.setItem("restServer", $scope.config.restServer);
                localStorage.setItem("b2cApplicationId", $scope.config.b2cApplicationId);
                localStorage.setItem("tenantName", $scope.config.tenantName);
                localStorage.setItem("signInPolicyName", $scope.config.signInPolicyName);
                localStorage.setItem("signInSignUpPolicyName", $scope.config.signInSignUpPolicyName);
				localStorage.setItem("redirect_uri", 'http://localhost:65159/redirect.html');
				
				var script = document.createElement('script');
                script.setAttribute('type', 'text/javascript');
                script.setAttribute('src', './aadb2c.js');
                document.head.appendChild(script);
				$scope.aadLogin(state);
				
            
				
                
		   
		   }
		   $scope.getConnectionStr=function(mac){
				//mac='"f4:8e:38:d0:80:c8"';
			    mac='"'+mac+'"';
			    console.log("MAC Address ::",mac);			   
			    var authResponse = hello('adB2CSignIn').getAuthResponse();
                if (authResponse != null) {
				$http({
                        url: $scope.config.restServer + 'api/IotHubGateway',
                        dataType: 'json',
                        method: 'POST',
						data:mac,
                        headers: {
                            "Content-Type": "application/json",
                           "Authorization": authResponse.token_type + ' ' + authResponse.access_token,
                        }
                    }).then(function (response) {
                        console.log("Connection String ::",response);
						$scope.saveConnectionStr(response.data.DeviceConnectionString);

                    })
                        .catch(function (error) {
                            console.log("Connection String Error ::",error);
                        });

                }
                else {
                    console.log("Please login");
                    
                } 
		   
		   }
		   $scope.saveConnectionStr=function(constr){
		   
					$http({
                        url: 'http://localhost:65159/connectionstring',
                        dataType: 'json',
                        method: 'POST',
						data:{'connectionString':constr},
                        headers: {
                            "Content-Type": "application/json",
                          
                        }
                    }).then(function (response) {
                        console.log(response);
						alert("Successfully stored connection string !");
                    })
                        .catch(function (error) {
                            
                        });
		   }
			$scope.getMacAddr=function(){
			
			  $http({
                        url: 'http://localhost:65159/macaddress',
                        dataType: 'json',
                        method: 'GET',
                        headers: {
                            "Content-Type": "application/json",
                          
                        }
                    }).then(function (response) {
                       
						$scope.getConnectionStr(response.data);
                    })
                        .catch(function (error) {
                            
                        });
			
				
			
			}
			$scope.aadLogin=function(state){
			aadService.signIn($scope.config,function (b2cSession) {
                if (!online(b2cSession) && state == 'click') {
                    aadService.policyLogin(helloNetwork.adB2CSignIn, loginDisplayType.Page);
                }
                else if (online(b2cSession) && state == 'intial') {
                    //getUserDetails();
					console.log("Heree");
					$scope.getMacAddr();
                }
				});      
			}
			
			
			$scope.getConfig=function(){
				$scope.config.restServer=localStorage.getItem("restServer");
                $scope.config.b2cApplicationId=localStorage.getItem("b2cApplicationId");
                $scope.config.tenantName=localStorage.getItem("tenantName");
                $scope.config.signInPolicyName=localStorage.getItem("signInPolicyName");
                if($scope.config.restServer){
					$scope.aadLogin('intial');
				}
			
			}
			
			$scope.getConfig();
         });
		 
      </script>
      
   </body>
</html>